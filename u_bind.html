<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>dyPhone</title>
		<link href="css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/index.css"/>
		<style type="text/css">
			.uc_pad {padding:20px 30px 20px 30px}
			.ucenter td {vertical-align: top;color:#999;font-size: 16px;}
			.ucenter td .tab_left {line-height: 35px;color:#333;font-size: 20px;}
			.ucenter table {
			    border-spacing: 5px;
			    border-collapse: initial;
			}
			.ucenter td textarea {margin-bottom: 5px;}
			.mui-input-row label {padding: 10px 15px 5px 15px}
			.mui-radio.mui-left input[type='radio'] {left: -1px;}
			.mui-radio.mui-left label {padding-left: 35px;padding-right: 35px;}
			.ucenter .mui-radio {margin-top:-10px}
			.ucenter .btns {padding:20px 5px 0 5px}	
			.mui-input-row .mui-btn {width:100%;}
			.ucenter .mui-btn-block {padding:7px 0;}
			.ucenter td .done {font-size: 12px;color:#00a0e9;line-height: 40px;text-indent: 1em;display: block;}
			.ucenter td .noyet {color:#ef0000}
			.tips {font-size: 14px;color:#999;line-height: 200%;padding:10px 20px;border-bottom:1px solid #e3e3e3}
			.mshow,.eshow {display: table-row;}
			.mhide,.ehide {display: none;}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<!--<a class="mui-action-menu mui-icon mui-pull-right txtIcon" href="u_reg.html">注册</a>-->
			<a class="mui-action-back mui-icon mui-icon-back mui-pull-left"></a>
			<h1 class="mui-title">个人资料</h1>
		</header>
		<div class="mui-content ucenter">
			<div class="tips">
				提示：用于绑定的手机与邮箱，在您的密码遗忘或被恶意篡改时，可用来进行密码找回，建议绑定。
			</div>
			<div class="uc_pad">
				<table border="0" cellspacing="0" cellpadding="5">
					<!--手机已绑定-->
					<tr class="mtab mshow">
						<td width="55"><span class="tab_left">手&nbsp;机</span></td>
						<td><input type="text" id="" value="15511653215" /></td>
						<td width="50"><span class="done">已绑定</span></td>
					</tr>
					<tr class="mtab mshow">
						<td><span class="tab_left">　&nbsp;　</span></td>
						<td><button type="button" class="mui-btn mui-btn-primary mui-btn-block">变更手机号</button></td>
						<td></td>
					</tr>
					<!--已绑定-->
					<!--手机未绑定-->
					<tr class="mtab mhide">
						<td width="55"><span class="tab_left">手&nbsp;机</span></td>
						<td><input type="text" id="mobile" value="" /></td>
						<td width="50"><span class="done noyet">请绑定</span></td>
					</tr>
					<tr class="inps mtab mhide">
						<td></td>
						<td><input type="text" id="code" value="" placeholder="验证码" /></td>
						<td valign="middle"><button type="button" id="pcode" class="mui-btn mui-btn-primary" rel="/index.php?s=/Home/Send/sendsms.html" style="margin-top: 3px;">发送</button></td>
					</tr>
					<tr class="mtab mhide">
						<td><span class="tab_left">　&nbsp;　</span></td>
						<td><button type="button" class="mui-btn mui-btn-primary mui-btn-block mbind" rel="/index.php?s=/Home/User/modifymobile.html">绑定</button></td>
						<td></td>
					</tr>
					<!--未绑定-->
					
					<tr height="50"><td></td><td></td><td></td></tr>
					
					<!--邮箱已绑定-->
					<tr class="etab ehide">
						<td width="55"><span class="tab_left">邮&nbsp;箱</span></td>
						<td><input type="text" value="718063475@qq.com" /></td>
						<td width="50"><span class="done">已绑定</span></td>
					</tr>
					<tr class="etab ehide">
						<td><span class="tab_left">　&nbsp;　</span></td>
						<td><button type="button" class="mui-btn mui-btn-primary mui-btn-block">变更邮箱</button></td>
						<td></td>
					</tr>
					<!--已绑定-->
					<!--邮箱未绑定-->
					<tr class="etab eshow">
						<td width="55"><span class="tab_left">邮&nbsp;箱</span></td>
						<td><input type="text" id="email" value="" /></td>
						<td width="50"><span class="done noyet">请绑定</span></td>
					</tr>
					<tr class="inps etab eshow">
						<td></td>
						<td><input type="text" id="code1" value="" placeholder="验证码" /></td>
						<td valign="middle"><button type="button" id="pcode1" class="mui-btn mui-btn-primary" rel="/index.php?s=/Home/Send/sendsms.html" style="margin-top: 3px;">发送</button></td>
					</tr>
					<tr class="etab eshow">
						<td><span class="tab_left">　&nbsp;　</span></td>
						<td><button type="button" class="mui-btn mui-btn-primary mui-btn-block ebind" rel="/index.php?s=/Home/User/modifymobile.html">绑定</button></td>
						<td></td>
					</tr>
					<!--未绑定-->
				</table>
				
			</div>
		</div>
		
		<script src="js/mui.min.js"></script>
		<script>
			mui.init();
			//绑定手机号
			var timer = '';
			document.querySelector('.mtab .mui-btn').addEventListener('tap', function(){
				var dom = document.querySelectorAll('.mshow');
				var dom1 = document.querySelectorAll('.mhide');
				for(var i = 0;i < dom.length;i++){
					dom[i].style.display = 'none';
				}
				for(var i = 0;i < dom1.length;i++){
					dom1[i].setAttribute('style','display: table-row;');
				}
			});
			document.querySelector('.mtab .mbind').addEventListener('tap',function(){
				bindPhone('mobile')
			});
			document.querySelector('#pcode').addEventListener('tap',function(){
				var url = this.getAttribute('rel'),mobile = document.querySelector('#mobile').value.replace(/-/g,'');
				if(/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/.test(mobile)){
					var txtt = document.getElementById('pcode').innerText;
					if(document.getElementById('pcode').innerText =='发送'){
						sendCode(url,0,mobile)
					}else{
						mui.toast('请等待计时完成！')	
					}
				}else{
					mui.toast('请正确填写手机号！')	
				}
			});
			
			function bindPhone(id){
				var url = document.querySelector('.mtab .mbind').getAttribute('rel'),phone = document.querySelector('#'+id).value.replace(/-/g,''),verify = document.querySelector('#code').value;
					if(/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/.test(phone)){
						if(/^[0-9]{6}$/.test(verify)){
							mui.post(url, {"phone":phone,"verify":verify}, success,'json');
						}else{
							mui.toast('验证码为6位数字！')	
						}
					}else{
						mui.toast('请正确填写手机号！')	
					}
					return false;
					function success(data){
						//layer.closeAll();
						//0 未登陆 1 成功 3 失败重试
						if(data.status == 1){
							mui.toast('修改成功！3秒后更新信息···');
							setTimeout(function(){
								window.location.href='./u_center.html';
							},3000)
						}else if(data.status == 0) {
							mui.toast(data.info);
//							setTimeout(function(){
//								window.location.href='/index.php?s=/Home/User/login.html';
//							},3000)
						}else if(data.status == 3) {
							mui.toast('绑定失败！请稍后再试···');
						}
					}
			}
			function sendCode(url,s_type,datas) {
				
				countTime();
				if(s_type == 0){
					mui.get(url,{"phone":datas}, success, "json");
				}else{
					mui.get(url,{"email":datas}, success, "json");
				}
				
				return false;
				function success(data){
					
					//1 成功 2失败  让用户重试，3 请用户半小时以后尝试发送
					if(data.status == 1){
						mui.toast('发送成功，请注意查收短信');
					}else if(data.status == 2) {
						mui.toast('发送失败！请重试···');
						clearInterval(timer);
					}else if(data.status == 3) {
						mui.toast('发送失败！请半小时后再次尝试发送···');
						clearInterval(timer);
					}else{
						mui.toast('系统错误，请联系客服！');
						clearInterval(timer);
					}
					
				}
			};
			function countTime() {
				var times = 30;
					timer = setInterval(conut, 1000);
				
				function conut() {
					if (times == 0) {
						clearInterval(timer);
						document.querySelector('#pcode').innerText='发送';
//						document.querySelector('#pcode').on('tap', function(){
//							var url = this.getAttribute('rel');
//							sendCode(url)
//						})
					} else {
						document.querySelector('#pcode').innerText=times + 's';
						times--;
					}
				}
			}
			
			//绑定youxiang
			document.querySelector('.etab .mui-btn').addEventListener('tap', function(){
				var dom = document.querySelectorAll('.eshow');
				var dom1 = document.querySelectorAll('.ehide');
				for(var i = 0;i < dom.length;i++){
					dom[i].style.display = 'none';
				}
				for(var i = 0;i < dom1.length;i++){
					dom1[i].setAttribute('style','display: table-row;');
				}
			});
			document.querySelector('.etab .ebind').addEventListener('tap',function(){
				bindEmail('email')
			});
			document.querySelector('#pcode1').addEventListener('tap',function(){
				var url = this.getAttribute('rel'),mobile = document.querySelector('#email').value;
				if(/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test(mobile)){
					var txtt = document.getElementById('pcode1').innerText;
					if(document.getElementById('pcode1').innerText =='发送'){
						sendCode(url,0,mobile)
					}else{
						mui.toast('请等待计时完成！')	
					}
				}else{
					mui.toast('请正确填写邮箱地址！')
				}
			});
			function bindEmail(id){
				var url = document.querySelector('.etab .ebind').getAttribute('rel'),email = document.querySelector('#email').value,code = document.querySelector('#code1').value;
					if(/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test(email) && code){
						mui.post('/index.php?s=/Home/User/modifymobile.html', {"email":email,"verify":code}, success,'json');
					}else{
						mui.toast('请正确填写Email地址和验证码！')	
					}
					//return false;
					function success(data){
						//layer.closeAll();
						//0 未登陆 1 成功 3 失败重试
						if(data.status == 1){
							mui.toast('修改成功！3秒后更新信息···',{time:3000});
							setTimeout(function(){
								location.reload()
							},3000)
						}else if(data.status == 0) {
							mui.toast('您未登陆！3秒后跳转到登陆页面···',{time:3000});
							setTimeout(function(){
								window.location.href='./u_log.html';
							},3000)
						}else if(data.status == 3) {
							mui.toast('绑定失败！请稍后再试···',{time:3000});
						}
					}
			}
		</script>
	</body>

</html>